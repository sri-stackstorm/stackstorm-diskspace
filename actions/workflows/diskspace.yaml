# This is a sample action file generated by Stackstorm VSCode Extension, Change as required.
version: 1.0
description: workflow for cleaning up /var
# input: {}
vars:
   - stdout: null
   - stderr: null
   - host: "40.122.212.105"
   - cmd: "df -h /var"
   - slack1: "T01CZJRGW4X/B01DNTP6PHQ"
   - slack2: "VKYMvy8KCHMlVj3Rpqd2pHZV"
   - slack: https://hooks.slack.com/services/<% ctx().slack1 %>/<% ctx().slack2 %>
tasks:
   echo_slack:
      action: core.local
      input:
         cmd: "echo <% ctx(slack) %>"
      next:
         - publish:
            - outputtask1: <% result() %>

   sending_notifications:
      action: slack.post_message
      input:
         message: "Recevied var filesystem alert kicking of self healing"
         webhook_url: <% ctx(slack) %>
         username: "slackautomation"
      next:
         - when: '{{ succeeded() }}'
           do:
             - check_dir_size
   check_dir_size:
      action: core.remote_sudo
      input:
         hosts: <% ctx(host) %>
         cmd: <% ctx(cmd) %>
         username: stockstorm
         password: admin123
         sudo_password: admin123
      next:
         - when: '{{ succeeded() }}'
           publish: stdout= <% result().stdout %>
           do:
             - sending_success_notification
         - when: '{{ failed() }}'
           publish: stderr= <% result().stderr %>
           do:
             - sending_failed_notification
   sending_success_notification:
      action: slack.post_message
      input:
         message: "cleared var filesystem successfully and self healing is completed"
         webhook_url: <% ctx(slack) %>
         username: "slackautomation"
   sending_failed_notification:
      action: slack.post_message
      input:
         message: "clearing var filesystem failed triggering escalation ticket"
         webhook_url: <% ctx(slack) %>
         username: "slackautomation"

output:
   - stdout: <% ctx(stdout) %>
   - stderr: <% ctx(stderr) %>
   - task1output: <% ctx(outputtask1) %>
